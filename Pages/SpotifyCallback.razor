@page "/callback"
@inject SpotifyAuthService SpotifyAuthService
@inject NavigationManager Navigation

<div class="d-flex justify-content-center align-items-center vh-100 text-center">
    <div>
        <div class="spinner-border text-primary" role="status" style="width: 3rem; height: 3rem;">
            <span class="visually-hidden">Loading...</span>
        </div>
        <h3 class="mt-3">Authenticating...</h3>
    </div>
</div>

@code {
    private bool hasRendered = false;

    protected override async Task OnInitializedAsync()
    {
        await Task.Delay(2000); // Simulate delay

        var query = Navigation.Uri.Split("?").Last();
        var parameters = Microsoft.AspNetCore.WebUtilities.QueryHelpers.ParseQuery(query);

        if (parameters.TryGetValue("code", out var code))
        {
            await SpotifyAuthService.GetAccessToken(code);
            StateHasChanged(); // Force UI update
        }
        else
        {
            Console.WriteLine("Error while authenticating, redirecting back to /login");
            Navigation.NavigateTo("/login");
        }
    }

    protected override async Task OnAfterRenderAsync(bool firstRender)
    {
        if (firstRender && !hasRendered)
        {
            hasRendered = true;
            await SpotifyAuthService.OnAfterRenderAsync();
            Navigation.NavigateTo("/home");
        }
    }
}